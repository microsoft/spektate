# GENERATED WITH SPK VERSION 0.6.1
trigger:
  branches:
    include:
      - master
  paths:
    include:
      - bedrock.yaml
variables: []
pool:
  vmImage: ubuntu-latest
steps:
  - task: HelmInstaller@1
    inputs:
      helmVersionToInstall: 2.16.3
  - script: |-
      set -e
      # Download build.sh
      curl $BEDROCK_BUILD_SCRIPT > build.sh
      chmod +x ./build.sh
    displayName: Download bedrock bash scripts
    env:
      BEDROCK_BUILD_SCRIPT: $(BUILD_SCRIPT_URL)
  - script: |-
      set -e
      # From https://raw.githubusercontent.com/Microsoft/bedrock/master/gitops/azure-devops/release.sh
      . build.sh --source-only

      # Initialization
      verify_access_token
      init
      helm_init

      # Fabrikate
      get_fab_version
      download_fab

      # SPK
      get_spk_version
      download_spk

      # Clone HLD repo
      git_connect

      # Update HLD via spk
      git checkout -b "RECONCILE/$(Build.Repository.Name)-$(Build.BuildNumber)"
      echo "spk hld reconcile $(Build.Repository.Name) $PWD ./.."
      spk hld reconcile $(Build.Repository.Name) $PWD ./..

      # Set git identity
      git config user.email "admin@azuredevops.com"
      git config user.name "Automated Account"

      # Commit changes
      echo "GIT ADD and COMMIT -- Will NOT throw error if there is nothing to commit."
      didCommit=0
      git_commit_if_changes "Reconciling HLD with $(Build.Repository.Name)-$(Build.BuildNumber)." 0 didCommit

      # Skip push and opening PR steps if there were no changes changes to commit.
      if [ $didCommit == 0 ]; then
      echo "DID NOT FIND CHANGES TO COMMIT. EXITING."
      exit 0
      fi

      # Git Push
      git_push

      # Open PR via az repo cli
      echo 'az extension add --name azure-devops'
      az extension add --name azure-devops

      echo 'az repos pr create --description "Reconciling HLD with $(Build.Repository.Name)-$(Build.BuildNumber)." "PR created by: $(Build.DefinitionName) with buildId: $(Build.BuildId) and buildNumber: $(Build.BuildNumber)"'
      az repos pr create --description "Reconciling HLD with $(Build.Repository.Name)-$(Build.BuildNumber)." "PR created by: $(Build.DefinitionName) with buildId: $(Build.BuildId) and buildNumber: $(Build.BuildNumber)"
    displayName: 'Download Fabrikate and SPK, Update HLD, Push changes, Open PR'
    env:
      ACCESS_TOKEN_SECRET: $(PAT)
      APP_REPO_URL: $(Build.Repository.Uri)
      AZURE_DEVOPS_EXT_PAT: $(PAT)
      REPO: $(HLD_REPO)
