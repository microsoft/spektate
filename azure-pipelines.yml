trigger:
  - master

pool:
  vmImage: "ubuntu-latest"

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "10.x"
    displayName: "Install Node.js"

  - script: |
      npm install
      npm install -g ts-node
      npm install -g pkg
    workingDirectory: "./"
    displayName: "npm install"

  - script: |
      npm run lint
    workingDirectory: "./"
    displayName: "tslint"

  - script: |
      npm run build
    displayName: "Build"

  - task: Docker@2
    inputs:
      containerRegistry: "spektateacrconnection"
      repository: "spektate"
      command: "buildAndPush"
      Dockerfile: "**/Dockerfile"
      tags: "spektate-$(Build.SourceBranchName)-$(Build.BuildId)"
    condition: ne(variables['Build.Reason'], 'PullRequest')

  - script: |
      cd packages/spektate
      npm install 
      npm run build
      npm run test
    displayName: "npm package build and test"

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/*coverage.xml"
      reportDirectory: "$(System.DefaultWorkingDirectory)/**/coverage"
